---
title: "Fitting vaccination effects on effective reproductive number for SARS-CoV-2 in the United States using linear mixed models"
author: "Marlin Figgins"
date: "09/27/2021"
output: html_document
---

```{r}
library(tidyverse)
```

```{r}
df <- read_csv("../sims/all-states-preprint-free/Rt/Rt_combined.csv") %>%
  mutate(location = str_replace(location, "_", " ")) %>%
  #group_by(location, date) %>%
  #mutate(relative_rt = median_R / median_R[variant == "other"]) %>%
  #ungroup() %>%
  filter(median_freq > 0.001) #Filter variants which median frequency less than 0.1
```

## Adding in vacc data

```{r}
# Read in CDC vaccination date
vacc <- read.csv("https://data.cdc.gov/api/views/unsk-b7fc/rows.csv?accessType=DOWNLOAD") %>%
  select(Date, Location, 
         Administered_Dose1_Pop_Pct, Series_Complete_Pop_Pct, 
         Administered_Dose1_Recip_18PlusPop_Pct, Series_Complete_18PlusPop_Pct, 
         Administered_Dose1_Recip_65PlusPop_Pct, Series_Complete_65PlusPop_Pct) %>%
  rename(location = Location, date = Date) %>%
  mutate(location = state.name[match(location, state.abb)],
         date = as.Date(date, format = "%m/%d/%Y"),
         date = date + 14) %>% # lag vaccination percentages by two weeks %>%
  mutate(second_dose_gap = (Administered_Dose1_Pop_Pct - Series_Complete_Pop_Pct) ) %>%
  mutate(Series_Complete_18PlusPop_Pct = Series_Complete_18PlusPop_Pct / 100) %>%
  filter(!is.na(location))

```

```{r}
vacc %>%
  ggplot(aes(x=date, id = location))+
  geom_line(aes(y = Series_Complete_18PlusPop_Pct)) +
facet_wrap(~ location)
```

## Vaccination modeling

```{r}
rt_vacc <- df %>% left_join(vacc)
```

```{r}
library(lme4)

#rt_vacc <- rt_vacc %>% filter(Series_Complete_18PlusPop_Pct > 0)
rt_vacc$variant <- relevel(as.factor(rt_vacc$variant), ref = "other")
rt_vacc$location <- as.factor(rt_vacc$location) 

# We fit a linear mixed model with fixed vaccination effect as well as random effects with variant and location
# For each variant, we predict a random slope and intercept and for each location the same
mixed.lmer <- lmer(log(median_R) ~  Series_Complete_18PlusPop_Pct + (1 + Series_Complete_18PlusPop_Pct|variant) + (1+Series_Complete_18PlusPop_Pct|location), data = rt_vacc, REML = FALSE, lmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')))
```


```{r}
overall_coefs <- coef(summary(mixed.lmer))[,"Estimate"]
location_coefs <- coef(mixed.lmer)$location
variant_coefs <- coef(mixed.lmer)$variant

location_coefs$`(Intercept)` <- location_coefs$`(Intercept)` + overall_coefs[1]
location_coefs$Series_Complete_18PlusPop_Pct <- location_coefs$`Series_Complete_18PlusPop_Pct` + overall_coefs[1]

data_to_predict <- crossing(location =  unique(rt_vacc$location),
         Series_Complete_18PlusPop_Pct = c(0., 1.),
         variant = unique(rt_vacc$variant))

data_to_predict$variant <- relevel(as.factor(data_to_predict$variant), ref = "other")
data_to_predict$location <- as.factor(data_to_predict$location) 

effects_to_plot <- cbind(data_to_predict, predicted_Rt = predict(mixed.lmer, newdata = data_to_predict, allow.new.levels = TRUE)) %>%
  group_by(location, variant) %>%
  summarize(intercept = predicted_Rt[Series_Complete_18PlusPop_Pct == 0],
            slope = predicted_Rt[Series_Complete_18PlusPop_Pct == 1] - predicted_Rt[Series_Complete_18PlusPop_Pct == 0])

effects_to_plot %>%
  pivot_longer(cols = c("intercept", "slope"), names_to = "effect", values_to = "estimate") %>%
  filter(effect == "slope") %>%
  mutate(effect = "Vaccination Effect") %>%
  ggplot(aes(y = location)) +
  geom_vline(xintercept = 0., linetype = "dashed") +
  geom_point(aes(x = estimate, color = variant)) + 
  scale_y_discrete(limits=rev) + 
  facet_wrap(~effect)
```
```{r}
vaccination_effects <- effects_to_plot %>%
  pivot_longer(cols = c("intercept", "slope"), names_to = "effect", values_to = "estimate")

vaccination_effects %>%
  filter(effect == "slope") %>%
  mutate(effect = "vaccination_slope") %>%
  write.table(file = "../data/sims/results/vaccination-effects_11_28_21.tsv", row.names=FALSE, sep = "\t")

read_tsv("../data/sims/results/vaccination-effects_11_28_21.tsv")
```

```{r}
effects_to_plot %>%
  pivot_longer(cols = c("intercept", "slope"), names_to = "effect", values_to = "estimate") %>%
  filter(effect == "slope") %>%
  mutate(effect = "Vaccination Effect") %>%
  ggplot(aes(fill = variant)) +
  geom_histogram(aes(x = estimate)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~variant) + 
  theme_minimal() + 
  xlab("Estimated vaccination effect") +
  ylab("") +
  theme(legend.title = element_blank(),
        legend.position="bottom",
        strip.text.x = element_text(size = 12))
```
```{r}
data_to_predict <- crossing(location =  unique(rt_vacc$location),
         Series_Complete_18PlusPop_Pct = c(0., 1.),
         variant = unique(rt_vacc$variant))
```


```{r}
library(lubridate)

rt_vacc %>%
  filter(mday(date) == 1) %>%
  ggplot(aes(x = Series_Complete_18PlusPop_Pct, color = variant)) +
  geom_point(aes(y = median_R)) +
  geom_smooth(aes(y=median_R), color = "black", method = "lm") +
  facet_grid(vars(date), vars(variant))
```

```{r}
library(lubridate)

adding_pred <- rt_vacc %>%
  filter(mday(date) == 1)

cbind(adding_pred, pred = predict(mixed.lmer, adding_pred)) %>%
  ggplot(aes(x = Series_Complete_18PlusPop_Pct, color = variant)) +
  geom_point(aes(y = median_R)) +
  geom_line(aes(y=exp(pred)), color = "black", method = "lm") +
  facet_grid(vars(date), vars(variant))
```

```{r}
library(lubridate)

rt_vacc %>%
  filter(mday(date) == 1) %>%
  ggplot(aes(x = Series_Complete_18PlusPop_Pct, color = variant)) +
  geom_point(aes(y = log(median_R))) +
  geom_line(aes(y = log(median_R), id = location)) +
   facet_wrap(~location)
```

```{r}
summary(mixed.lmer)
coef(summary(mixed.lmer))
```